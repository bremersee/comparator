<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>WellKnownTextParser.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Comparator</a> &gt; <a href="index.source.html" class="el_package">org.bremersee.comparator</a> &gt; <span class="el_source">WellKnownTextParser.java</span></div><h1>WellKnownTextParser.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2019-2022 the original author or authors.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package org.bremersee.comparator;

import java.util.ArrayList;
import java.util.Comparator;
import java.util.List;
import java.util.Objects;
import java.util.Optional;
import java.util.StringTokenizer;
import java.util.function.Function;
import javax.validation.Valid;
import javax.validation.constraints.NotNull;
import org.bremersee.comparator.model.ComparatorField;
import org.bremersee.comparator.model.WellKnownTextProperties;

/**
 * Parses the string representation of a sort order and creates a comparator.
 *
 * &lt;p&gt;The default implementation supports the following syntax:
 * &lt;pre&gt;
 * fieldNameOrPath0,asc,ignoreCase,nullIsFirst|fieldNameOrPath1,asc,ignoreCase,nullIsFirst
 * &lt;/pre&gt;
 *
 * &lt;p&gt;For example
 * &lt;pre&gt;
 * person.lastName,asc,true,false|person.firstName,asc,true,false
 * &lt;/pre&gt;
 *
 * @author Christian Bremer
 */
@Valid
public interface WellKnownTextParser {

  /**
   * Gets properties.
   *
   * @return the properties
   */
  @NotNull
  default WellKnownTextProperties getProperties() {
<span class="fc" id="L56">    return WellKnownTextProperties.defaults();</span>
  }

  /**
   * Parses the string representation of a sort order and creates a comparator.
   *
   * &lt;p&gt;The default implementation supports the following syntax:
   * &lt;pre&gt;
   * fieldNameOrPath0,asc,ignoreCase,nullIsFirst|fieldNameOrPath1,asc,ignoreCase,nullIsFirst
   * &lt;/pre&gt;
   *
   * &lt;p&gt;For example
   * &lt;pre&gt;
   * person.lastName,asc,true,false|person.firstName,asc,true,false
   * &lt;/pre&gt;
   *
   * @param wkt the string representation of a sort order (as well known text)
   * @return the created comparator
   */
  @NotNull
  default Comparator&lt;Object&gt; parse(String wkt) {
<span class="fc" id="L77">    ComparatorBuilder builder = ComparatorBuilder.builder();</span>
<span class="fc bfc" id="L78" title="All 2 branches covered.">    for (ComparatorField comparatorField : buildComparatorFields(wkt)) {</span>
      //noinspection rawtypes
<span class="fc" id="L80">      Comparator comparator = apply(comparatorField);</span>
<span class="pc bpc" id="L81" title="1 of 2 branches missed.">      if (comparator != null) {</span>
<span class="fc" id="L82">        builder.add(comparator);</span>
      }
<span class="fc" id="L84">    }</span>
<span class="fc" id="L85">    return builder.build();</span>
  }

  /**
   * Builds a list of comparator fields from the string representation of a sort order.
   *
   * &lt;p&gt;The default implementation supports the following syntax:
   * &lt;pre&gt;
   * fieldNameOrPath0,asc,ignoreCase,nullIsFirst|fieldNameOrPath1,asc,ignoreCase,nullIsFirst
   * &lt;/pre&gt;
   *
   * &lt;p&gt;For example
   * &lt;pre&gt;
   * person.lastName,asc,true,false|person.firstName,asc,true,false
   * &lt;/pre&gt;
   *
   * @param wkt the string representation of a sort order (as well known text)
   * @return the list of comparator fields
   */
  @NotNull
  default List&lt;ComparatorField&gt; buildComparatorFields(String wkt) {
<span class="fc" id="L106">    return Optional.ofNullable(wkt)</span>
<span class="fc" id="L107">        .map(text -&gt; {</span>
<span class="fc" id="L108">          List&lt;ComparatorField&gt; fields = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L109">          StringTokenizer tokenizer = new StringTokenizer(text,</span>
<span class="fc" id="L110">              getProperties().getFieldSeparator());</span>
<span class="fc bfc" id="L111" title="All 2 branches covered.">          while (tokenizer.hasMoreTokens()) {</span>
<span class="fc" id="L112">            fields.add(buildComparatorField(tokenizer.nextToken()));</span>
          }
<span class="fc" id="L114">          return fields;</span>
        })
<span class="fc" id="L116">        .orElseGet(List::of);</span>
  }

  /**
   * Builds a comparator field from the string representation of a sort order (must be a single
   * field, not a path).
   *
   * &lt;p&gt;The default implementation supports the following syntax:
   * &lt;pre&gt;
   * fieldNameOrPath,asc,ignoreCase,nullIsFirst
   * &lt;/pre&gt;
   *
   * &lt;p&gt;For example
   * &lt;pre&gt;
   * person.lastName,asc,true,false
   * &lt;/pre&gt;
   *
   * @param fieldDescription the field description
   * @return the comparator field
   */
  @NotNull
  default ComparatorField buildComparatorField(String fieldDescription) {
<span class="fc" id="L138">    WellKnownTextProperties props = getProperties();</span>
<span class="fc" id="L139">    String field = null;</span>
<span class="fc" id="L140">    boolean asc = props.isAsc(null);</span>
<span class="fc" id="L141">    boolean ignoreCase = props.isCaseIgnored(null);</span>
<span class="fc" id="L142">    boolean nullIsFirst = props.isNullFirst(null);</span>
<span class="fc bfc" id="L143" title="All 2 branches covered.">    if (fieldDescription != null) {</span>
<span class="fc" id="L144">      String separator = props.getFieldArgsSeparator();</span>
<span class="fc" id="L145">      int index = fieldDescription.indexOf(separator);</span>
<span class="fc bfc" id="L146" title="All 2 branches covered.">      if (index &lt; 0) {</span>
<span class="fc" id="L147">        field = fieldDescription.trim();</span>
      } else {
<span class="fc" id="L149">        field = fieldDescription.substring(0, index).trim();</span>
<span class="fc" id="L150">        int from = index + separator.length();</span>
<span class="fc" id="L151">        index = fieldDescription.indexOf(separator, from);</span>
<span class="fc bfc" id="L152" title="All 2 branches covered.">        if (index &lt; 0) {</span>
<span class="fc" id="L153">          asc = props.isAsc(fieldDescription.substring(from).trim());</span>
        } else {
<span class="fc" id="L155">          asc = props.isAsc(fieldDescription.substring(from, index).trim());</span>
<span class="fc" id="L156">          from = index + separator.length();</span>
<span class="fc" id="L157">          index = fieldDescription.indexOf(separator, from);</span>
<span class="fc bfc" id="L158" title="All 2 branches covered.">          if (index &lt; 0) {</span>
<span class="fc" id="L159">            ignoreCase = props.isCaseIgnored(fieldDescription.substring(from).trim());</span>
          } else {
<span class="fc" id="L161">            ignoreCase = props.isCaseIgnored(fieldDescription.substring(from, index).trim());</span>
<span class="fc" id="L162">            from = index + separator.length();</span>
<span class="fc" id="L163">            nullIsFirst = props.isNullFirst(fieldDescription.substring(from).trim());</span>
          }
        }
      }
    }
<span class="fc bfc" id="L168" title="All 4 branches covered.">    field = field == null || field.length() == 0 ? null : field;</span>
<span class="fc" id="L169">    return new ComparatorField(field, asc, ignoreCase, nullIsFirst);</span>
  }

  /**
   * Creates the comparator for the given field.
   *
   * @param comparatorField the comparator field
   * @return the comparator
   */
  @NotNull
  @SuppressWarnings(&quot;rawtypes&quot;)
  Comparator apply(ComparatorField comparatorField);

  /**
   * New instance well known text parser.
   *
   * @param comparatorFunction the comparator function
   * @return the well known text parser
   */
  @NotNull
  @SuppressWarnings(&quot;rawtypes&quot;)
  static WellKnownTextParser newInstance(
      @NotNull Function&lt;ComparatorField, Comparator&gt; comparatorFunction) {
<span class="fc" id="L192">    return newInstance(comparatorFunction, null);</span>
  }

  /**
   * New instance well known text parser.
   *
   * @param comparatorFunction the comparator function
   * @param properties the properties
   * @return the well known text parser
   */
  @NotNull
  @SuppressWarnings(&quot;rawtypes&quot;)
  static WellKnownTextParser newInstance(
      @NotNull Function&lt;ComparatorField, Comparator&gt; comparatorFunction,
      WellKnownTextProperties properties) {
<span class="fc" id="L207">    return new Impl(comparatorFunction, properties);</span>
  }

  /**
   * An implementation.
   */
  @SuppressWarnings(&quot;rawtypes&quot;)
  class Impl implements WellKnownTextParser {

    private final Function&lt;ComparatorField, Comparator&gt; comparatorFunction;

    private final WellKnownTextProperties properties;

    private Impl(Function&lt;ComparatorField, Comparator&gt; comparatorFunction,
<span class="fc" id="L221">        WellKnownTextProperties properties) {</span>
<span class="fc" id="L222">      this.comparatorFunction = comparatorFunction;</span>
<span class="fc" id="L223">      this.properties = Objects.requireNonNullElse(properties, WellKnownTextProperties.defaults());</span>
<span class="fc" id="L224">    }</span>

    @Override
    public WellKnownTextProperties getProperties() {
<span class="fc" id="L228">      return properties;</span>
    }

    @Override
    public Comparator apply(ComparatorField comparatorField) {
<span class="nc" id="L233">      return comparatorFunction.apply(comparatorField);</span>
    }
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>